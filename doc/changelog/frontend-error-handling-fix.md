# å‰ç«¯é”™è¯¯å¤„ç†ä¿®å¤è®°å½•

## é—®é¢˜æ¦‚è¿°

å‰ç«¯ç”¨æˆ·æ³¨å†Œç•Œé¢æ— æ³•æ­£ç¡®æ˜¾ç¤ºåç«¯è¿”å›çš„é”™è¯¯ä¿¡æ¯ï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒä¸ä½³ï¼Œç”¨æˆ·æ— æ³•äº†è§£æ³¨å†Œå¤±è´¥çš„å…·ä½“åŸå› ã€‚

## å‘ç°çš„é—®é¢˜

### 1. APIå“åº”æ‹¦æˆªå™¨é—®é¢˜
- **é—®é¢˜æè¿°**: å“åº”æ‹¦æˆªå™¨ç›´æ¥è¿”å› `response.data`ï¼Œæ²¡æœ‰å¤„ç†HTTPé”™è¯¯çŠ¶æ€ç 
- **å½±å“**: å‰ç«¯æ— æ³•æ¥æ”¶åˆ°åç«¯çš„é”™è¯¯å“åº”ï¼Œå¯¼è‡´é”™è¯¯ä¿¡æ¯ä¸¢å¤±

### 2. é”™è¯¯å¤„ç†é€»è¾‘é—®é¢˜
- **é—®é¢˜æè¿°**: å‰ç«¯æ²¡æœ‰æ­£ç¡®å¤„ç†HTTPé”™è¯¯çŠ¶æ€ç å’Œé”™è¯¯å“åº”
- **å½±å“**: å³ä½¿åç«¯è¿”å›äº†è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œå‰ç«¯ä¹Ÿæ— æ³•æ­£ç¡®è§£æå’Œæ˜¾ç¤º

### 3. é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºé—®é¢˜
- **é—®é¢˜æè¿°**: å‰ç«¯é”™è¯¯æç¤ºæ ·å¼å•ä¸€ï¼Œæ— æ³•åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯
- **å½±å“**: ç”¨æˆ·æ— æ³•å¿«é€Ÿè¯†åˆ«æ˜¯æˆåŠŸæ¶ˆæ¯è¿˜æ˜¯é”™è¯¯æ¶ˆæ¯

### 4. æˆåŠŸæ¶ˆæ¯å¤„ç†é—®é¢˜
- **é—®é¢˜æè¿°**: æ³¨å†ŒæˆåŠŸåæ²¡æœ‰æ˜ç¡®çš„æˆåŠŸæç¤º
- **å½±å“**: ç”¨æˆ·æ— æ³•ç¡®è®¤æ³¨å†Œæ˜¯å¦æˆåŠŸ

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤APIå“åº”æ‹¦æˆªå™¨

#### ä¿®å¤å‰
```typescript
// å“åº”æ‹¦æˆªå™¨
apiClient.interceptors.response.use(
  (response) => {
    return response.data;
  },
  (error) => {
    // ç»Ÿä¸€é”™è¯¯å¤„ç†
    console.error('API è¯·æ±‚é”™è¯¯:', error);
    return Promise.reject(error);
  }
);
```

#### ä¿®å¤å
```typescript
// å“åº”æ‹¦æˆªå™¨
apiClient.interceptors.response.use(
  (response) => {
    // å¦‚æœå“åº”çŠ¶æ€ç æ˜¯2xxï¼Œç›´æ¥è¿”å›æ•°æ®
    return response.data;
  },
  (error) => {
    // ç»Ÿä¸€é”™è¯¯å¤„ç†
    if (error.response) {
      // æœåŠ¡å™¨è¿”å›äº†é”™è¯¯çŠ¶æ€ç 
      const { status, data } = error.response;
      console.error('API å“åº”é”™è¯¯:', status, data);
      
      // å¦‚æœåç«¯è¿”å›äº†ç»“æ„åŒ–çš„é”™è¯¯ä¿¡æ¯ï¼Œä½¿ç”¨å®ƒ
      if (data && typeof data === 'object') {
        return Promise.reject({
          code: status,
          message: data.message || `è¯·æ±‚å¤±è´¥ (${status})`,
          data: data.data || null
        });
      }
      
      // å¦åˆ™è¿”å›é€šç”¨çš„é”™è¯¯ä¿¡æ¯
      return Promise.reject({
        code: status,
        message: `è¯·æ±‚å¤±è´¥ (${status})`,
        data: null
      });
    } else if (error.request) {
      // è¯·æ±‚å·²å‘å‡ºä½†æ²¡æœ‰æ”¶åˆ°å“åº”
      return Promise.reject({
        code: 0,
        message: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
        data: null
      });
    } else {
      // è¯·æ±‚é…ç½®å‡ºé”™
      return Promise.reject({
        code: 0,
        message: 'è¯·æ±‚é…ç½®é”™è¯¯',
        data: null
      });
    }
  }
);
```

### 2. å®Œå–„é”™è¯¯å¤„ç†é€»è¾‘

#### ä¿®å¤å‰
```typescript
} catch (err) {
  setError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
  console.error('è®¤è¯å¤±è´¥:', err);
}
```

#### ä¿®å¤å
```typescript
} catch (err: unknown) {
  // å¤„ç†APIé”™è¯¯å“åº”
  if (err && typeof err === 'object' && 'message' in err && typeof err.message === 'string') {
    setError(err.message);
  } else {
    setError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
  }
  console.error('è®¤è¯å¤±è´¥:', err);
}
```

### 3. æ”¹è¿›é”™è¯¯æç¤ºæ ·å¼

#### ä¿®å¤å‰
```typescript
{/* é”™è¯¯æç¤º */}
{error && (
  <motion.div className="bg-red-500/20 border border-red-500/30 rounded-xl text-red-300 backdrop-blur-sm">
    {error}
  </motion.div>
)}
```

#### ä¿®å¤å
```typescript
{/* é”™è¯¯æç¤º */}
{error && (
  <motion.div className={`border rounded-xl backdrop-blur-sm ${
    // æ ¹æ®é”™è¯¯å†…å®¹åˆ¤æ–­æ˜¯æˆåŠŸæ¶ˆæ¯è¿˜æ˜¯é”™è¯¯æ¶ˆæ¯
    error.includes('æˆåŠŸ') || error.includes('æ³¨å†ŒæˆåŠŸ')
      ? 'bg-green-500/20 border-green-500/30 text-green-300'
      : 'bg-red-500/20 border-red-500/30 text-red-300'
  }`}>
    <div className="flex items-center space-x-2">
      {error.includes('æˆåŠŸ') || error.includes('æ³¨å†ŒæˆåŠŸ') ? (
        <svg className="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
        </svg>
      ) : (
        <svg className="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      )}
      <span>{error}</span>
    </div>
  </motion.div>
)}
```

### 4. æ·»åŠ æˆåŠŸæ¶ˆæ¯å¤„ç†

#### æ³¨å†ŒæˆåŠŸåçš„å¤„ç†
```typescript
if (response.code === 200) {
  setError('');
  setIsLogin(true); // æ³¨å†ŒæˆåŠŸååˆ‡æ¢åˆ°ç™»å½•
  // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
  setError('æ³¨å†ŒæˆåŠŸï¼è¯·ä½¿ç”¨æ–°è´¦æˆ·ç™»å½•');
  // æ¸…ç©ºè¡¨å•
  setFormData({ username: '', password: '', email: '' });
  // 3ç§’åæ¸…é™¤æˆåŠŸæ¶ˆæ¯
  setTimeout(() => setError(''), 3000);
}
```

## ä¿®å¤çš„æ–‡ä»¶

### 1. APIå±‚
- `frontend/aii-home/src/requests/api/index.ts` - ä¿®å¤å“åº”æ‹¦æˆªå™¨

### 2. ç»„ä»¶å±‚
- `frontend/aii-home/src/components/AuthPanel.tsx` - å®Œå–„é”™è¯¯å¤„ç†å’ŒUIæ˜¾ç¤º

### 3. æµ‹è¯•è„šæœ¬
- `scripts/test_error_handling.sh` - Linux/macOSé”™è¯¯å¤„ç†æµ‹è¯•è„šæœ¬
- `scripts/test_error_handling.bat` - Windowsé”™è¯¯å¤„ç†æµ‹è¯•è„šæœ¬

## ä¿®å¤åçš„åŠŸèƒ½ç‰¹æ€§

### 1. å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… HTTPçŠ¶æ€ç æ­£ç¡®è§£æ
- âœ… åç«¯é”™è¯¯ä¿¡æ¯å®Œæ•´æ˜¾ç¤º
- âœ… ç½‘ç»œé”™è¯¯å‹å¥½æç¤º
- âœ… è¯·æ±‚é…ç½®é”™è¯¯å¤„ç†

### 2. æ™ºèƒ½æ¶ˆæ¯æ˜¾ç¤º
- âœ… æˆåŠŸæ¶ˆæ¯ç»¿è‰²æ˜¾ç¤º
- âœ… é”™è¯¯æ¶ˆæ¯çº¢è‰²æ˜¾ç¤º
- âœ… å›¾æ ‡åŒºåˆ†æ¶ˆæ¯ç±»å‹
- âœ… åŠ¨ç”»æ•ˆæœå¢å¼ºä½“éªŒ

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- âœ… æ³¨å†ŒæˆåŠŸåæ˜ç¡®æç¤º
- âœ… è‡ªåŠ¨åˆ‡æ¢åˆ°ç™»å½•æ¨¡å¼
- âœ… è¡¨å•è‡ªåŠ¨æ¸…ç©º
- âœ… æˆåŠŸæ¶ˆæ¯è‡ªåŠ¨æ¶ˆå¤±

### 4. é”™è¯¯ä¿¡æ¯åˆ†ç±»
- âœ… 400 - è¯·æ±‚å‚æ•°é”™è¯¯
- âœ… 401 - è®¤è¯å¤±è´¥
- âœ… 409 - æ•°æ®å†²çª
- âœ… 500 - æœåŠ¡å™¨é”™è¯¯

## æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹
1. **æ­£å¸¸æ³¨å†Œ** - éªŒè¯æˆåŠŸæ¶ˆæ¯æ˜¾ç¤º
2. **é‡å¤ç”¨æˆ·å** - éªŒè¯409é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
3. **é‡å¤é‚®ç®±** - éªŒè¯409é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
4. **å¼±å¯†ç ** - éªŒè¯400é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
5. **æ— æ•ˆé‚®ç®±** - éªŒè¯400é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
6. **ç¼ºå°‘å­—æ®µ** - éªŒè¯400é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
7. **é”™è¯¯å¯†ç ** - éªŒè¯401é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
8. **ç½‘ç»œé”™è¯¯** - éªŒè¯ç½‘ç»œé”™è¯¯æç¤º

### è¿è¡Œæµ‹è¯•
```bash
# Linux/macOS
chmod +x scripts/test_error_handling.sh
./scripts/test_error_handling.sh

# Windows
scripts/test_error_handling.bat
```

## é”™è¯¯ä¿¡æ¯ç¤ºä¾‹

### æˆåŠŸæ¶ˆæ¯
- ğŸŸ¢ "æ³¨å†ŒæˆåŠŸï¼è¯·ä½¿ç”¨æ–°è´¦æˆ·ç™»å½•"

### é”™è¯¯æ¶ˆæ¯
- ğŸ”´ "ç”¨æˆ·åå·²è¢«ä½¿ç”¨"
- ğŸ”´ "é‚®ç®±å·²è¢«æ³¨å†Œ"
- ğŸ”´ "å¯†ç å¿…é¡»å¤§äº8ä½ï¼ŒåŒ…å«æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦"
- ğŸ”´ "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
- ğŸ”´ "ç”¨æˆ·åã€é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©º"
- ğŸ”´ "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
- ğŸ”´ "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®"

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. é”™è¯¯ç±»å‹åˆ¤æ–­
```typescript
// æ ¹æ®é”™è¯¯å†…å®¹åˆ¤æ–­æ¶ˆæ¯ç±»å‹
const isSuccessMessage = error.includes('æˆåŠŸ') || error.includes('æ³¨å†ŒæˆåŠŸ');
const messageClass = isSuccessMessage 
  ? 'bg-green-500/20 border-green-500/30 text-green-300'
  : 'bg-red-500/20 border-red-500/30 text-red-300';
```

### 2. å›¾æ ‡åŠ¨æ€æ˜¾ç¤º
```typescript
// æ ¹æ®æ¶ˆæ¯ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡
const icon = isSuccessMessage ? (
  <svg className="w-5 h-5 text-green-400">
    <path d="M5 13l4 4L19 7" />
  </svg>
) : (
  <svg className="w-5 h-5 text-red-400">
    <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
);
```

### 3. æˆåŠŸæ¶ˆæ¯è‡ªåŠ¨æ¶ˆå¤±
```typescript
// 3ç§’åè‡ªåŠ¨æ¸…é™¤æˆåŠŸæ¶ˆæ¯
setTimeout(() => setError(''), 3000);
```

## éƒ¨ç½²æ³¨æ„äº‹é¡¹

### 1. å‰ç«¯é‡æ–°æ„å»º
ä¿®å¤å®Œæˆåéœ€è¦é‡æ–°æ„å»ºå‰ç«¯ä»£ç ã€‚

### 2. åç«¯æ¥å£æµ‹è¯•
ç¡®ä¿åç«¯æ¥å£è¿”å›æ­£ç¡®çš„HTTPçŠ¶æ€ç å’Œé”™è¯¯ä¿¡æ¯ã€‚

### 3. æµè§ˆå™¨å…¼å®¹æ€§
æµ‹è¯•åœ¨ä¸åŒæµè§ˆå™¨ä¸­çš„æ˜¾ç¤ºæ•ˆæœã€‚

## åç»­ä¼˜åŒ–å»ºè®®

### 1. é”™è¯¯ä¿¡æ¯å›½é™…åŒ–
- æ”¯æŒå¤šè¯­è¨€é”™è¯¯æç¤º
- æ ¹æ®ç”¨æˆ·è¯­è¨€è®¾ç½®æ˜¾ç¤ºå¯¹åº”è¯­è¨€

### 2. é”™è¯¯ä¿¡æ¯æŒä¹…åŒ–
- ä¿å­˜é”™è¯¯æ—¥å¿—åˆ°æœ¬åœ°å­˜å‚¨
- æä¾›é”™è¯¯æŠ¥å‘ŠåŠŸèƒ½

### 3. ç”¨æˆ·ä½“éªŒå¢å¼º
- æ·»åŠ é”™è¯¯æç¤ºéŸ³æ•ˆ
- å®ç°é”™è¯¯æ¶ˆæ¯åˆ†ç±»è¿‡æ»¤
- æ”¯æŒé”™è¯¯æ¶ˆæ¯æœç´¢

### 4. æ€§èƒ½ä¼˜åŒ–
- é”™è¯¯æ¶ˆæ¯é˜²æŠ–å¤„ç†
- é”™è¯¯ä¿¡æ¯ç¼“å­˜æœºåˆ¶
- å¼‚æ­¥é”™è¯¯å¤„ç†

## æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œå‰ç«¯é”™è¯¯å¤„ç†ç°åœ¨å…·å¤‡äº†ï¼š
- ğŸ¯ å®Œæ•´çš„HTTPé”™è¯¯çŠ¶æ€ç å¤„ç†
- ğŸ” è¯¦ç»†çš„åç«¯é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
- ğŸ¨ æ™ºèƒ½çš„æ¶ˆæ¯ç±»å‹è¯†åˆ«å’Œæ ·å¼
- ğŸš€ ä¼˜åŒ–çš„ç”¨æˆ·ä½“éªŒå’Œäº¤äº’
- ğŸ§ª å…¨é¢çš„æµ‹è¯•è¦†ç›–

ç”¨æˆ·ç°åœ¨å¯ä»¥æ¸…æ¥šåœ°äº†è§£æ³¨å†Œå¤±è´¥çš„å…·ä½“åŸå› ï¼Œå¤§å¤§æå‡äº†ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚
